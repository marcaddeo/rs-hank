version: 2
jobs:
  build:
    working_directory: /home/rust/src
    docker:
      - image: ekidd/rust-musl-builder:latest
    steps:
      - checkout
      - restore_cache:
          key: cargo.registry
      - restore_cache:
          key: target-{{ checksum "Cargo.lock" }}
      - run:
          name: Compile Hank
          command: cargo build --release
      - save_cache:
          key: target-{{ checksum "Cargo.lock" }}
          paths:
            - target
      - persist_to_workspace:
          root: /home/rust/src/target/x86_64-unknown-linux-musl/release
          paths:
            - hank
      - save_cache:
          key: cargo.registry
          paths:
            - /root/.cargo

  deploy-production:
    working_directory: /tmp
    docker:
      - image: rust:latest
    steps:
      - attach_workspace:
          at: /tmp/release
      - run:
          name: Stop Hank
          command: ssh -oStrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} 'pm2 stop hank'
      - run:
          name: Deploy Hank executable
          command: scp -oStrictHostKeyChecking=no release/hank ${DEPLOY_USER}@${DEPLOY_HOST}:bin/hank
      - run:
          name: Start Hank
          command: ssh -oStrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} 'pm2 start hank'

  deploy-staging:
    working_directory: /tmp
    docker:
      - image: rust:latest
    steps:
      - attach_workspace:
          at: /tmp/release
      - run:
          name: Stop Hank
          command: ssh -oStrictHostKeyChecking=no hank-staging@${DEPLOY_HOST} 'pm2 stop hank'
      - run:
          name: Deploy Hank executable
          command: scp -oStrictHostKeyChecking=no release/hank hank-staging@${DEPLOY_HOST}:bin/hank
      - run:
          name: Start Hank
          command: ssh -oStrictHostKeyChecking=no hank-staging@${DEPLOY_HOST} 'pm2 start hank'

workflows:
  version: 2
  deploy-production:
    jobs:
      - build:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - deploy-staging:
          requires:
            - build
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - hold:
          type: approval
          requires:
            - deploy-staging
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - deploy-production:
          requires:
            - hold
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/

  deploy-staging:
    jobs:
      - build
      - deploy-staging:
          requires:
            - build
          filters:
            branches:
              only: master
